# Filter: only VMs that asked for KV-backed password
locals {
  vms_with_kv_pw = {
    for k, v in var.vms :
    k => v if try(v.use_kv_password, false)
  }
}

# Strong random password per VM (only for opted-in VMs)
resource "random_password" "vm_pw" {
  for_each = local.vms_with_kv_pw

  length           = 20
  special          = true
  min_lower        = 1
  min_upper        = 1
  min_numeric      = 1
  min_special      = 1
  # Safe set for Windows/Key Vault
  override_special = "_%@#&-+!?"
}

# Store those passwords in Key Vault
resource "azurerm_key_vault_secret" "vm_pw" {
  for_each     = local.vms_with_kv_pw

  name         = coalesce(
                   try(each.value.os_profiles.admin_password_secret_name, null),
                   "localadmin-${each.key}"
                 )
  value        = random_password.vm_pw[each.key].result
  key_vault_id = data.azurerm_key_vault.vm_passwords.id
  content_type = "auto-generated by Terraform"
  tags         = var.global_tags
}
